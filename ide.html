<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
    <meta http-equiv="Content-Security-Policy" content="
    default-src 'self' blob: data:; 
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com; 
    connect-src 'self' https://cdn.jsdelivr.net https://storage.googleapis.com https://unpkg.com https://raw.githubusercontent.com https://teachablemachine.withgoogle.com ws:; 
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; 
    font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net; 
    img-src 'self' data: https: https://unpkg.com; 
    media-src 'self' https://unpkg.com; 
    worker-src 'self' blob: data:;
    ">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Block IDE</title>
    <link rel="preload" as="image" href="/assets/ESP32.png">
    <link rel="icon" href="data:,">
</head>
<body>
<div class="ide-container">
        <header class="main-header">
            <div class="header-project-info">
                <button id="back-to-projects-btn" class="btn icon-btn" title="Back to Projects">
                    <svg viewBox="0 0 24 24"><path d="M19 12H5" /><path d="m12 19-7-7 7-7" /></svg>
                </button>
                <div id="project-title-wrapper" title="Click to rename">
                    <h1 id="current-project-name">Project Name</h1>
                    <span id="header-board-badge" class="board-badge">ESP32</span>
                </div>
                <button id="rename-project-btn" class="btn icon-btn" title="Rename Project">
                    <svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </button>
            </div>
            <div class="header-view-toggle">
                <div class="view-toggle-btn-group">
                    <button id="blocks-view-btn" class="view-toggle-btn active">BLOCKS</button>
                    <button id="code-view-btn" class="view-toggle-btn">CODE</button>
                </div>
                <button id="live-mode-btn" class="btn icon-btn" title="Toggle Live Mode (Execute blocks directly on device)">
                   <svg viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                </button>
            </div>

            <div class="header-actions">
                <button id="share-project-btn" class="btn" title="Generate a shareable link for this project">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                </button>
                <button id="start-tutorial-btn" class="btn" title="Start a Tutorial">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2 L14.5 9.5 L22 12 L14.5 14.5 L12 22 L9.5 14.5 L2 12 L9.5 9.5 Z"/></svg>
                </button>
                <button id="dashboard-btn" class="btn" title="IoT Dashboard" style="display: none;">
                    <svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/><path d="M18 10h-1.26A8 8 0 1 0 4 16.25"/></svg>
                </button>
                <button id="ai-monitor-btn" class="btn" title="AI Monitor">
                    <svg viewBox="0 0 24 24"><path d="M12 12a3 3 0 100-6 3 3 0 000 6z"/><path d="M20.9 19.8A10 10 0 103.1 4.2"/></svg>
                </button>
                <button id="plotter-btn" class="btn" title="Live Data Plotter">
                    <svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" /></svg>
                </button>
                <button id="console-btn" class="btn" title="Console">
                    <svg viewBox="0 0 24 24"><path d="M18 10L12 16L6 10" /></svg>
                </button>
            </div>
        </header>

        <aside class="left-sidebar">
            <div class="sidebar-top">
                <div id="sidebar-board-view" class="sidebar-view active">
                    <div id="board-viewer-container" class="board-viewer">
                        <img id="board-image" src="" alt="Selected Microcontroller Board">
                        <video id="sidebar-webcam" playsinline autoplay muted></video>
                        <canvas id="sidebar-canvas-overlay"></canvas>
                    </div>
                </div>

                <div id="sidebar-file-view" class="sidebar-view">
                    <div id="file-explorer-wrapper">
                        <div class="file-explorer-header">
                            <h3>Project Files</h3>
                            <div class="file-explorer-actions">
                                <button id="device-files-btn" class="btn icon-btn" title="Device File Manager">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>
                                </button>
                                <button id="new-file-btn" class="btn icon-btn" title="New File">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                </button>
                            </div>
                        </div>
                        <div id="file-tree-container"></div>
                    </div>
                </div>
            </div>

            <div class="sidebar-bottom">
                <div class="connection-container">
                    <div class="connect-button-group">
                        <div class="dropdown">
                            <button id="connect-dropdown-btn" class="btn">Connect</button>
                            <div class="dropdown-content">
                                <a href="#" id="connect-usb-btn">Connect via USB</a>
                                <a href="#" id="connect-wifi-btn">Connect via Wi-Fi</a>
                                <a href="#" id="connect-ble-btn" style="display: none;">Connect via BLE</a> 
                            </div>
                        </div>
                        <div id="connection-status-wrapper" class="connection-disconnected">
                            <span>Disconnected</span>
                        </div>
                    </div>
                </div>
                <div class="action-grid">
                    <button id="upload-code" class="btn primary" disabled>
                        <svg viewBox="0 0 24 24"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242" /><path d="M12 12v9" /><path d="m16 16-4-4-4 4" /></svg>
                        <span>Upload to Device</span>
                    </button>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <div id="blocklyArea"></div>
            <div id="code-only-overlay" style="display: none;">
                <div class="code-only-message">
                  <svg viewBox="0 0 24 24"><path d="M10 22v-6M14 22v-6"/><path d="M4 8V4h16v4"/><path d="M6 16h12a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2z"/></svg>
                   <h2>Editing Device File</h2>
                   <p>You are viewing a file directly from the device. Block editing is disabled to prevent accidental changes.<br>Switch to <strong>main.py</strong> in the file explorer to return to the block editor.</p>
                </div>
            </div>

            <div id="monaco-editor-container" style="width:100%; height:100%; display: none;"></div>

            <div id="read-only-banner" style="display: none;">
               <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                 <div>
                  <h4>Read-Only Mode</h4>
                <p>You are viewing a file from the device. Editing is disabled. Select <strong>main.py</strong> to return to the block editor.</p>
               </div>
            </div>

            <div id="console-view" class="view-wrapper"><div class="view-header"><h3>Console</h3><button id="clear-console-btn" class="btn icon-btn" title="Clear Console"><svg viewBox="0 0 24 24"><path d="M20 5H4a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1V6a1 1 0 0 0-1-1zM4 11h16a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-2a1 1 0 0 1 1-1zm2 7h12a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1v-2a1 1 0 0 1 1-1z"/></svg></button></div><div class="console-output" id="console-output"></div><div class="console-input-wrapper"><span>></span><input type="text" id="console-input" placeholder="Type command and press Enter..." autocomplete="off"></div></div>
            <div id="plotter-view" class="view-wrapper">
                <div class="view-header">
                    <h3>Live Data Plotter</h3>
                    <p class="plotter-tip">Use a `print("plot:NAME:COLOR:VALUE")` block to send data here.</p>
                </div>
                <div class="plotter-canvas-container">
                    <canvas id="plotter-canvas"></canvas>
                </div>
            </div>
        </main>
    </div>

    <!-- ALL MODALS GO HERE -->
    <div id="custom-prompt-modal" class="modal-backdrop" style="display: none;"><div class="modal-content"><p id="custom-prompt-message"></p><input type="text" id="custom-prompt-input"><div class="modal-buttons"><button id="custom-prompt-ok" class="btn primary">OK</button><button id="custom-prompt-cancel" class="btn">Cancel</button></div></div></div>
    <div id="custom-confirm-modal" class="modal-backdrop" style="display: none;"><div class="modal-content"><p id="custom-confirm-message"></p><div class="modal-buttons"><button id="custom-confirm-yes" class="btn primary">Yes</button><button id="custom-confirm-no" class="btn">No</button></div></div></div>
    <div id="upload-status-modal" class="modal-backdrop" style="display: none;"><div class="modal-content upload-status-content"><div id="upload-status-icon" class="upload-status-icon"></div><p id="upload-status-message">Uploading...</p></div></div>
    <div id="extension-modal" class="modal-backdrop" style="display: none;"><div class="modal-content extension-modal-content"><div class="modal-header"><h2>Choose an Extension</h2><button id="extension-modal-close-btn" class="titlebar-btn">&times;</button></div><div id="extension-list" class="extension-list"></div></div></div>
    <div id="tutorial-modal" class="modal-backdrop" style="display: none;"><div class="modal-content extension-modal-content"><div class="modal-header"><h2>Choose a Tutorial</h2><button id="tutorial-modal-close-btn" class="titlebar-btn">&times;</button></div><div id="tutorial-list" class="extension-list"></div></div></div>
    <div id="ai-monitor-modal" class="modal-backdrop" style="display: none;"><div class="modal-content ai-monitor-content"><div class="modal-header" id="ai-monitor-header"><h2>AI Vision Monitor</h2><button id="ai-monitor-close-btn" class="titlebar-btn">&times;</button></div><div class="ai-monitor-controls"><button class="ai-monitor-toggle" data-model="face">Face Landmarks</button><button class="ai-monitor-toggle" data-model="hand">Hand Gesture</button><button class="ai-monitor-toggle" data-model="classification">Image Classify</button><button class="ai-monitor-toggle" data-model="detection">Object Detect</button><button class="ai-monitor-toggle" data-model="custom" style="display: none;">Custom Model</button></div><div class="ai-monitor-body"><div class="ai-monitor-video-container"><canvas id="ai-monitor-canvas"></canvas></div><div class="ai-monitor-data-container"><pre id="ai-monitor-data-output"><p class="ai-monitor-placeholder">Waiting for data...</p></pre></div></div></div></div>
    <div id="new-file-modal" class="modal-backdrop" style="display: none;">
    <div class="modal-content" style="min-width: 450px;">
    <div class="modal-header">
            <h2>Create New File</h2>
        </div>
        <div class="form-group" style="margin-top: 1rem;">
            <label for="new-file-name-input">File Name</label>
            <input type="text" id="new-file-name-input" placeholder="e.g., my_library.py or lib/sensor.py">
            <small style="color: var(--text-tertiary); margin-top: 0.5rem;">For files in a library folder, use the format `lib/filename.py`.</small>
        </div>
        <div class="modal-buttons">
            <button id="new-file-cancel-btn" class="btn secondary">Cancel</button>
            <button id="new-file-create-btn" class="btn primary" disabled>Create</button>
        </div>
      </div>
    </div>
    <div id="block-genius-toast" class="block-genius-toast">
        <div class="genius-header">
            <svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01 9 11.01"/></svg>
            <h3 id="genius-title">Block Genius</h3>
            <button id="genius-close-btn">&times;</button>
        </div>
        <div class="genius-body">
            <div class="genius-text">
                <p id="genius-description">A helpful tip about this block.</p>
            </div>
            <div class="genius-diagram">
                <img id="genius-image" src="" alt="Wiring Diagram">
            </div>
        </div>
    </div>

    <!-- IoT Dashboard Builder Modal -->
    <div id="iot-dashboard-modal" class="modal-backdrop" style="display: none;">
        <div class="iot-dashboard-content">
            <!-- Main Header of the Modal -->
            <div class="canvas-header">
                 <h2 class="canvas-title">IoT Dashboard Builder</h2>
                 <div class="view-toggle">
                    <button class="view-toggle-btn active" data-view="laptop">Desktop</button>
                    <button class="view-toggle-btn" data-view="mobile">Mobile</button>
                </div>
                <div class="canvas-actions">
                    <button id="dashboard-load-template-btn" class="btn">Load Template</button>
                    <button id="dashboard-clear-btn" class="btn">Clear Canvas</button>
                    <button id="dashboard-export-btn" class="btn primary">Generate HTML & Blocks</button>
                    <button id="dashboard-close-btn" class="titlebar-btn">&times;</button>
                </div>
            </div>
            <!-- 3-Column Body -->
            <div class="iot-dashboard-body">
                <!-- Column 1: Component Palette -->
                <aside class="palette">
                    <div class="palette-section"><h3>Controls</h3><div class="component-list">
                        <div class="component-item" data-type="button" draggable="true"><div class="component-icon">üîò</div><div class="component-name">Button</div></div>
                        <div class="component-item" data-type="slider" draggable="true"><div class="component-icon">üéöÔ∏è</div><div class="component-name">Slider</div></div>
                        <div class="component-item" data-type="toggle" draggable="true"><div class="component-icon">üîõ</div><div class="component-name">Toggle</div></div>
                        <div class="component-item" data-type="color-picker" draggable="true"><div class="component-icon">üé®</div><div class="component-name">Color</div></div>
                        <div class="component-item" data-type="joystick" draggable="true"><div class="component-icon">üïπÔ∏è</div><div class="component-name">Joystick</div></div>
                    </div></div>
                    <div class="palette-section"><h3>Displays</h3><div class="component-list">
                        <div class="component-item" data-type="gauge" draggable="true"><div class="component-icon">üå°Ô∏è</div><div class="component-name">Gauge</div></div>
                        <div class="component-item" data-type="line-chart" draggable="true"><div class="component-icon">üìâ</div><div class="component-name">Line Chart</div></div>
                        <div class="component-item" data-type="led" draggable="true"><div class="component-icon">üí°</div><div class="component-name">LED</div></div>
                        <div class="component-item" data-type="label" draggable="true"><div class="component-icon">üî§</div><div class="component-name">Text</div></div>
                        <div class="component-item" data-type="card" draggable="true"><div class="component-icon">üÉè</div><div class="component-name">Card</div></div>
                    </div></div>
                        <div class="palette-section"><h3>Layout & Text</h3><div class="component-list">
                        <div class="component-item" data-type="container" draggable="true"><div class="component-icon">üñºÔ∏è</div><div class="component-name">Container</div></div>
                        <div class="component-item" data-type="heading" draggable="true"><div class="component-icon"><strong>H1</strong></div><div class="component-name">Heading</div></div>
                        <div class="component-item" data-type="paragraph" draggable="true"><div class="component-icon">¬∂</div><div class="component-name">Paragraph</div></div>
                        <div class="component-item" data-type="image" draggable="true"><div class="component-icon">üèûÔ∏è</div><div class="component-name">Image</div></div>
                    </div></div>
                </aside>
                <!-- Column 2: The Canvas -->
                <main class="canvas-container">
                    <div class="canvas" id="dashboard-canvas"></div>
                </main>
                <!-- Column 3: Properties Panel -->
                <aside class="properties-panel">
                    <div class="properties-header">Properties</div>
                    <div id="properties-content">
                        <div id="no-selection-prompt"><div class="icon">üëÜ</div><p>Select a component to edit.</p></div>
                
                        <!-- General Properties -->
                        <div class="property-group" data-prop-group="general"><h4 class="prop-title">General</h4>
                            <div class="property-item" data-prop="id"><label for="prop-id">Unique ID</label><input type="text" id="prop-id"></div>
                        </div>

                        <!-- Text Properties -->
                        <div class="property-group" data-prop-group="text"><h4 class="prop-title">Text</h4>
                            <div class="property-item" data-prop="label"><label for="prop-label">Label / Text</label><textarea id="prop-label" rows="3"></textarea></div>
                            <div class="property-item" data-prop="fontSize"><label for="prop-fontSize">Font Size (px)</label><input type="number" id="prop-fontSize"></div>
                            <div class="property-item" data-prop="fontWeight"><label for="prop-fontWeight">Font Weight</label><select id="prop-fontWeight"><option value="400">Normal</option><option value="700">Bold</option></select></div>
                            <div class="property-item" data-prop="textAlign"><label for="prop-textAlign">Alignment</label><select id="prop-textAlign"><option value="left">Left</option><option value="center">Center</option><option value="right">Right</option></select></div>
                        </div>

                        <!-- Appearance Properties -->
                        <div class="property-group" data-prop-group="appearance"><h4 class="prop-title">Appearance</h4>
                            <div class="property-item" data-prop="color"><label for="prop-color">Primary/Text Color</label><input type="color" id="prop-color" value="#007aff"></div>
                            <div class="property-item" data-prop="bgColor"><label for="prop-bgColor">Background Color</label><input type="color" id="prop-bgColor" value="#ffffff"></div>
                            <div class="property-item" data-prop="borderColor"><label for="prop-borderColor">Border Color</label><input type="color" id="prop-borderColor" value="#e5e7eb"></div>
                            <div class="property-item" data-prop="borderRadius"><label for="prop-borderRadius">Corner Radius (px)</label><input type="number" id="prop-borderRadius"></div>
                            <div class="property-item" data-prop="shape"><label for="prop-shape">Shape</label><select id="prop-shape"><option value="rectangle">Rectangle</option><option value="rounded">Rounded</option><option value="circle">Circle</option></select></div>
                        </div>

                        <!-- Layout Properties -->
                        <div class="property-group" data-prop-group="layout"><h4 class="prop-title">Layout</h4>
                            <div class="property-item" data-prop="width"><label for="prop-width">Width (px)</label><input type="number" id="prop-width"></div>
                            <div class="property-item" data-prop="height"><label for="prop-height">Height (px)</label><input type="number" id="prop-height"></div>
                            <div class="property-item" data-prop="radius" style="display: none;"><label for="prop-radius">Radius (px)</label><input type="number" id="prop-radius"></div>
                        </div>

                        <!-- Data Properties -->
                        <div class="property-group" data-prop-group="data"><h4 class="prop-title">Data & Values</h4>
                            <div class="property-item" data-prop="value"><label for="prop-value">Default Value</label><input type="text" id="prop-value"></div>
                            <div class="property-item" data-prop="min"><label for="prop-min">Min Value</label><input type="number" id="prop-min"></div>
                            <div class="property-item" data-prop="max"><label for="prop-max">Max Value</label><input type="number" id="prop-max"></div>
                            <div class="property-item" data-prop="valueX" style="display: none;"><label for="prop-valueX">X Value</label><input type="number" id="prop-valueX" readonly></div>
                            <div class="property-item" data-prop="valueY" style="display: none;"><label for="prop-valueY">Y Value</label><input type="number" id="prop-valueY" readonly></div>
                            <div class="property-item" data-prop="src"><label for="prop-src">Image URL</label><input type="text" id="prop-src"></div>
                            <div class="property-item" data-prop="colorOn"><label for="prop-colorOn">"ON" Color</label><input type="color" id="prop-colorOn" value="#34c759"></div>
                            <div class="property-item" data-prop="colorOff"><label for="prop-colorOff">"OFF" Color</label><input type="color" id="prop-colorOff" value="#555555"></div>
                        </div>
                
                        <!-- Actions -->
                        <div class="property-group" data-prop-group="actions">
                            <button class="btn-delete" id="delete-component">Delete Component</button>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="export-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Export Dashboard</h2>
                <button class="modal-close" id="modal-close-btn">&times;</button>
            </div>
            <div class="export-section">
                <h3>MicroPython HTML String</h3>
                <p class="plotter-tip">Copy this and paste it into a text block in your code.</p>
                <textarea id="export-code-micropython" readonly></textarea>
                <button id="copy-micropython-btn" class="copy-btn">Copy for MicroPython</button>
            </div>
        </div>
    </div>

    <div id="file-manager-modal" class="modal-backdrop" style="display: none;">
        <div class="modal-content" style="min-width: 700px; max-width: 80vw;">
            <div class="modal-header">
                <h2>Device File Manager</h2>
                <button id="file-manager-close-btn" class="titlebar-btn">&times;</button>
            </div>

            <div id="file-manager-body">
                <!-- Breadcrumbs will be injected here by JS -->
                <div id="file-manager-breadcrumbs" class="breadcrumbs"></div>

                <!-- Header for the file list -->
                <div class="file-list-header">
                    <div class="file-header-name">Name</div>
                    <div class="file-header-actions">Actions</div>
                </div>

                <!-- The actual list of files and folders -->
                <div id="file-list-container">
                    <p>Connecting to device... Click "Refresh" to list files.</p>
                </div>
            </div>

            <div class="modal-buttons" style="justify-content: space-between;">
                <!-- Left Group: Global & Utility Actions -->
                <div class="button-group-left">
                    <button id="library-manager-btn" class="btn secondary">Library Manager</button>
                    <button id="device-info-btn" class="btn secondary">Device Info</button>
                    <button id="save-to-device-btn" class="btn secondary">Save Code to Device</button>
                    <button id="export-project-btn" class="btn secondary">Save Project to Computer</button>
                    <button id="clean-upload-btn" class="btn warning">Clean & Upload</button>
                </div>
                <!-- Right Group: List-Specific Actions -->
                <div class="button-group-right">
                    <input type="file" id="file-manager-upload-input" style="display: none;" />
                    <button id="file-manager-upload-btn" class="btn secondary">Upload File</button>
                    <button id="file-manager-refresh-btn" class="btn primary">Refresh</button>
                </div>
            </div>
        </div>
    </div>

    <div id="device-info-modal" class="modal-backdrop" style="display: none;">
        <div class="modal-content" style="min-width: 550px;">
            <div class="modal-header">
                <h2>Device Information</h2>
                <button id="device-info-close-btn" class="titlebar-btn">&times;</button>
            </div>
            <div id="device-info-content">
                <p class="device-info-loading">Querying device...</p>
                <!-- Info will be populated here by JS -->
            </div>
        </div>
    </div>
    <div id="library-manager-modal" class="modal-backdrop" style="display: none;">
        <div class="modal-content" style="min-width: 600px;">
            <div class="modal-header">
                <h2>Install a Library</h2>
                <button id="library-manager-close-btn" class="titlebar-btn">&times;</button>
            </div>
            <div id="library-list-container" style="max-height: 60vh; overflow-y: auto; padding: 1rem 0;">
                <!-- Library list will be injected here -->
            </div>
        </div>
    </div>

    <div id="webrepl-modal" class="modal-backdrop" style="display: none;">
        <div class="modal-content" style="min-width: 550px;">
            <div class="webrepl-tabs">
                <button id="webrepl-connect-tab" class="webrepl-tab-btn active">Connect to Existing Device</button>
                <button id="webrepl-setup-tab" class="webrepl-tab-btn">New Device Setup</button>
            </div>

            <!-- TAB 1: Connect to an already configured device -->
            <div id="webrepl-connect-content" class="webrepl-tab-content active">
                <h2 class="modal-title">Connect via WebREPL</h2>
                <p>Enter the IP address of your device. Ensure WebREPL is started on the device.</p>
                <div class="form-group">
                    <label for="webrepl-ip-input">Device IP Address or Hostname</label>
                    <input type="text" id="webrepl-ip-input" placeholder="e.g., 192.168.1.100 or my-pico.local">
                </div>
                <div class="modal-buttons">
                    <button id="webrepl-cancel-btn" class="btn secondary">Cancel</button>
                    <button id="webrepl-connect-btn" class="btn primary">Connect</button>
                </div>
            </div>

            <!-- TAB 2: Setup a new device from scratch -->
            <div id="webrepl-setup-content" class="webrepl-tab-content">
                <h2 class="modal-title">New WebREPL Device Setup</h2>
                <p>This will configure your device to connect to Wi-Fi and start WebREPL automatically. A **USB connection is required** for this one-time setup.</p>
                <div class="form-group">
                    <label for="webrepl-setup-ssid">Wi-Fi Network Name (SSID)</label>
                    <input type="text" id="webrepl-setup-ssid" placeholder="Your Wi-Fi Name">
                </div>
                <div class="form-group">
                    <label for="webrepl-setup-wifi-pass">Wi-Fi Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="webrepl-setup-wifi-pass" name="wifi-password" autocomplete="current-password" placeholder="Your Wi-Fi Password">
                        <button class="password-toggle-btn" type="button" title="Show/Hide Password">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="webrepl-setup-repl-pass">WebREPL Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="webrepl-setup-repl-pass" name="repl-password" autocomplete="new-password" placeholder="Create a password">
                        <button class="password-toggle-btn" type="button" title="Show/Hide Password">üëÅÔ∏è</button>
                    </div>
                </div>
                 <div class="form-group">
                    <label for="webrepl-setup-repl-pass-confirm">Confirm WebREPL Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="webrepl-setup-repl-pass-confirm" name="repl-password-confirm" autocomplete="new-password" placeholder="Confirm the password">
                        <button class="password-toggle-btn" type="button" title="Show/Hide Password">üëÅÔ∏è</button>
                    </div>
                </div>
                <div id="webrepl-setup-status" class="setup-status"></div>
                <div class="modal-buttons">
                    <button id="webrepl-setup-cancel-btn" class="btn secondary">Cancel</button>
                    <button id="webrepl-setup-btn" class="btn primary">Start Setup</button>
                </div>
            </div>
        </div>
    </div>

    <div id="ble-modal" class="modal-backdrop" style="display: none;">
    <div class="modal-content" style="min-width: 550px;">
        <div class="webrepl-tabs">
            <button id="ble-connect-tab" class="webrepl-tab-btn active">Connect to Device</button>
            <button id="ble-setup-tab" class="webrepl-tab-btn">New Device Setup</button>
        </div>

        <!-- TAB 1: Connect to an already configured device -->
        <div id="ble-connect-content" class="webrepl-tab-content active">
            <h2 class="modal-title">Connect via Bluetooth (WebREPL)</h2>
            <p>Scan for nearby ESP32 devices that have been set up for BLE WebREPL.</p>
            
            <div id="ble-device-list" style="margin: 1rem 0; max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--radius);">
                <!-- Scanned devices will appear here -->
                <p style="padding: 1rem; color: var(--text-secondary);">Click "Scan" to find devices.</p>
            </div>

            <div class="modal-buttons">
                <button id="ble-cancel-btn" class="btn secondary">Cancel</button>
                <button id="ble-scan-btn" class="btn primary">Scan for Devices</button>
            </div>
        </div>

        <!-- TAB 2: Setup a new device from scratch -->
        <div id="ble-setup-content" class="webrepl-tab-content">
            <h2 class="modal-title">New BLE WebREPL Device Setup</h2>
            <p>This will configure your ESP32 to start a BLE REPL automatically. A **USB connection is required** for this one-time setup.</p>
            <div class="form-group">
                <label for="ble-setup-name">Bluetooth Device Name</label>
                <input type="text" id="ble-setup-name" placeholder="e.g., MyESP32-REPL" value="ESP32-BLE-REPL">
            </div>
            <div id="ble-setup-status" class="setup-status"></div>
            <div class="modal-buttons">
                <button id="ble-setup-cancel-btn" class="btn secondary">Cancel</button>
                <button id="ble-setup-btn" class="btn primary">Start Setup</button>
            </div>
        </div>
    </div>
</div>

    <script type="module" src="/src/ide/ide-entry.js"></script>
</body>
</html>